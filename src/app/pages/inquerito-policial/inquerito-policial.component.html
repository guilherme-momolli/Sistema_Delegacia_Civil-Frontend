<div class="container py-4">
  <h1 class="mb-4">Inquéritos Policiais</h1>

  <div class="mb-3">
    <button class="btn btn-primary" (click)="abrirModal()">
      Cadastrar Inquérito
    </button>
  </div>

  <!-- Tabela de Inquéritos -->
  <div class="table-responsive">
    <table class="table table-dark table-striped table-bordered text-center align-middle">
      <thead class="table-primary">
        <tr>
          <th>Nº Justiça</th>
          <th>Ordem IP</th>
          <th>Data</th>
          <th>Peça</th>
          <th>Situação</th>
          <th>Pessoas</th>
          <th>Bens</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        @for (inq of inqueritos(); track inq.id) {
        <tr>
          <td>{{ inq.numeroJustica }}</td>
          <td>{{ inq.ordemIp }}</td>
          <td>{{ inq.data | date: 'dd/MM/yyyy' }}</td>
          <td>{{ getDescricaoPeca(inq.peca ?? '') }}</td>
          <td>{{ getDescricaoSituacao(inq.situacaoInquerito ?? '') }}</td>
          <td>{{inq.pessoasEnvolvidas.length || 0}}</td>
          <td>{{inq.bensEnvolvidos?.length || 0}}</td>
          <td class="text-center">
            <div class="d-flex gap-2 justify-content-center">

              <button class="btn btn-warning btn-sm me-1" (click)="abrirModal(inq)" title="Editar">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-danger btn-sm" (click)="excluir(inq)" title="Excluir">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        </tr>
        } @empty {
        <tr>
          <td colspan="6" class="text-muted">Nenhum inquérito cadastrado.</td>
        </tr>
        }
      </tbody>
    </table>
  </div>

  <div class="modal fade" id="formModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg">

        <form [formGroup]="inqueritoForm" (ngSubmit)="salvar()">

          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">
              {{ isEdicao() ? 'Editar Inquérito' : 'Novo Inquérito' }}
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body p-0">

            <!-- Nav Tabs -->
            <ul class="nav nav-tabs nav-fill" role="tablist">
              <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-inquerito" type="button">
                  Inquérito
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-pessoas" type="button">
                  Pessoas
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-bens" type="button">
                  Bens
                </button>
              </li>
            </ul>

            <div class="tab-content p-3">

              <div class="tab-pane fade show active" id="tab-inquerito">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Número Justiça <span class="text-danger">*</span></label>
                    <input formControlName="numeroJustica" type="text" class="form-control"
                      [class.is-invalid]="inqueritoForm.get('numeroJustica')?.invalid && inqueritoForm.get('numeroJustica')?.touched">
                    <div class="invalid-feedback">Campo obrigatório.</div>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label fw-bold">Ordem IP <span class="text-danger">*</span></label>
                    <input formControlName="ordemIp" type="number" class="form-control"
                      [class.is-invalid]="inqueritoForm.get('ordemIp')?.invalid && inqueritoForm.get('ordemIp')?.touched">
                  </div>

                  <div class="col-md-6">
                    <label class="form-label fw-bold">Data <span class="text-danger">*</span></label>
                    <input formControlName="data" type="date" class="form-control"
                      [class.is-invalid]="inqueritoForm.get('data')?.invalid && inqueritoForm.get('data')?.touched">
                  </div>

                  <div class="col-md-6">
                    <label class="form-label fw-bold">Peça <span class="text-danger">*</span></label>
                    <select formControlName="peca" class="form-select"
                      [class.is-invalid]="inqueritoForm.get('peca')?.invalid && inqueritoForm.get('peca')?.touched">
                      <option [ngValue]="null">Selecione...</option>
                      @for (p of pecas; track p.key) {
                      <option [value]="p.key">{{ p.value }}</option>
                      }
                    </select>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label fw-bold">Situação <span class="text-danger">*</span></label>
                    <select formControlName="situacaoInquerito" class="form-select"
                      [class.is-invalid]="inqueritoForm.get('situacaoInquerito')?.invalid && inqueritoForm.get('situacaoInquerito')?.touched">
                      <option [ngValue]="null">Selecione...</option>
                      @for (s of situacoes; track s.key) {
                      <option [value]="s.key">{{ s.value }}</option>
                      }
                    </select>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label fw-bold">Origem Força Policial <span class="text-danger">*</span></label>
                    <select formControlName="origemForcaPolicial" class="form-select"
                      [class.is-invalid]="inqueritoForm.get('origemForcaPolicial')?.invalid && inqueritoForm.get('origemForcaPolicial')?.touched">
                      <option [ngValue]="null">Selecione...</option>
                      @for (o of origens; track o.key) {
                      <option [value]="o.key">{{ o.value }}</option>
                      }
                    </select>
                  </div>

                  <div class="col-12">
                    <label class="form-label fw-bold">Natureza do Delito <span class="text-danger">*</span></label>
                    <input formControlName="naturezaDoDelito" type="text" class="form-control"
                      [class.is-invalid]="inqueritoForm.get('naturezaDoDelito')?.invalid && inqueritoForm.get('naturezaDoDelito')?.touched">
                  </div>

                  <div class="col-12">
                    <label class="form-label fw-bold">Observação</label>
                    <textarea formControlName="observacao" rows="3" class="form-control"></textarea>
                  </div>
                </div>
              </div>

              <div class="tab-pane fade" id="tab-pessoas">

                <div class="card border-primary mb-3">
                  <div class="card-body p-3">
                    <div class="row g-2 align-items-end">
                      <div class="col-md-4">
                        <input type="text" class="form-control form-control-sm" placeholder="Nome"
                          (input)="atualizarFiltroNome($event)">
                      </div>
                      <div class="col-md-3">
                        <input type="text" class="form-control form-control-sm" placeholder="CPF"
                          (input)="atualizarFiltroCpf($event)">
                      </div>
                      <div class="col-md-3">
                        <select class="form-select form-select-sm" (change)="atualizarFiltroSexo($event)">
                          <option value="">Todos os Gêneros</option>
                          @for (g of generos; track g.key) {
                          <option [value]="g.key">{{ g.value }}</option>
                          }
                        </select>
                      </div>
                      <div class="col-md-2">
                        <button type="button" class="btn btn-primary btn-sm w-100" (click)="buscarPessoas()">
                          Buscar
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                @if (pessoasFiltradas().length > 0) {
                <div class="table-responsive mb-3">
                  <table class="table table-sm table-hover">
                    <thead class="table-light">
                      <tr>
                        <th>Nome</th>
                        <th>CPF</th>
                        <th>Gênero</th>
                        <th>Tipo</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (p of pessoasFiltradas(); track p.id) {
                      <tr>
                        <td>{{ p.nome }}</td>
                        <td>{{ p.cpf }}</td>
                        <td>{{ getDescricaoGenero(p.sexo) }}</td>
                        <td>
                          <select class="form-select form-select-sm" #tipoSelect>
                            @for (t of tiposEnvolvimento; track t.key) {
                            <option [value]="t.key">{{ t.value }}</option>
                            }
                          </select>
                        </td>
                        <td>
                          <button type="button" class="btn btn-success btn-sm"
                            (click)="adicionarPessoa(p, tipoSelect.value)">
                            Adicionar
                          </button>
                        </td>
                      </tr>
                      }
                    </tbody>
                  </table>
                </div>
                }

                <h6 class="mb-2">Pessoas Envolvidas:</h6>
                <div formArrayName="pessoasEnvolvidas">
                  @if (pessoasArray().length > 0) {
                  <div class="table-responsive">
                    <table class="table table-sm table-striped">
                      <thead class="table-light">
                        <tr>
                          <th>Nome</th>
                          <th>Tipo</th>
                          <th>Observação</th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (ctrl of pessoasArray().controls; let i = $index; track i) {
                        <tr [formGroupName]="i">
                          <td>{{ getPessoaNome(ctrl.get('pessoaId')?.value) }}</td>
                          <td>
                            <select formControlName="tipoEnvolvimento" class="form-select form-select-sm">
                              @for (t of tiposEnvolvimento; track t.key) {
                              <option [value]="t.key">{{ t.value }}</option>
                              }
                            </select>
                          </td>
                          <td>
                            <input formControlName="observacao" type="text" class="form-control form-control-sm"
                              placeholder="Opcional">
                          </td>
                          <td>
                            <button type="button" class="btn btn-outline-danger btn-sm" (click)="removerPessoa(i)">
                              Remover
                            </button>
                          </td>
                        </tr>
                        }
                      </tbody>
                    </table>
                  </div>
                  } @else {
                  <p class="text-muted fst-italic">Nenhuma pessoa adicionada.</p>
                  }
                </div>
              </div>

              <div class="tab-pane fade" id="tab-bens">

                <div class="card border-success mb-3">
                  <div class="card-body p-3">
                    <div class="row g-2 align-items-end">
                      <div class="col-md-4">
                        <input type="text" class="form-control form-control-sm" placeholder="Descrição do bem"
                          (input)="atualizarFiltroDescricao($event)">
                      </div>

                      <div class="col-md-3">
                        <input type="text" class="form-control form-control-sm" placeholder="Marca"
                          (input)="atualizarFiltroMarca($event)">
                      </div>

                      <div class="col-md-3">
                        <select class="form-select form-select-sm" (change)="atualizarFiltroTipo($event)">
                          <option value="">Todos os tipos</option>
                          @for (t of tiposBem; track t.key) {
                          <option [value]="t.key">{{ t.value }}</option>
                          }
                        </select>
                      </div>

                      <div class="col-md-2">
                        <button type="button" class="btn btn-success btn-sm w-100" (click)="buscarBens()">
                          Buscar
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                @if (bensFiltrados().length > 0) {
                <div class="table-responsive mb-3">
                  <table class="table table-sm table-hover align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>Descrição</th>
                        <th>Marca / Modelo</th>
                        <th>Tipo de Envolvimento</th>
                        <th>Observação</th>
                        <th class="text-center">Ação</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (bem of bensFiltrados(); track bem.id) {
                      <tr>
                        <td class="text-truncate" style="max-width: 200px;" title="{{ bem.descricao }}">
                          {{ bem.descricao }}
                        </td>

                        <td>{{ bem.marca }} {{ bem.modelo }}</td>

                        <td>
                          <select class="form-select form-select-sm" #tipoBem>
                            @for (t of bemTipoEnvolvimento; track t.key) {
                            <option [value]="t.key">{{ t.value }}</option>
                            }
                          </select>
                        </td>

                        <td>
                          <input type="text" class="form-control form-control-sm" placeholder="Opcional" #obsBem>
                        </td>

                        <td class="text-center">
                          <button type="button" class="btn btn-success btn-sm"
                            (click)="adicionarBem(bem, tipoBem.value); obsBem.value = ''">
                            Adicionar
                          </button>
                        </td>
                      </tr>
                      }
                    </tbody>
                  </table>
                </div>
                } @else if (filtrosBem().descricao || filtrosBem().marca || filtrosBem().tipo) {
                <p class="text-muted text-center fst-italic">Nenhum bem encontrado.</p>
                }

                <h6 class="mb-2 mt-4">Bens Envolvidos no Inquérito:</h6>
                <div formArrayName="bensEnvolvidos">
                  @if (bensArray().length > 0) {
                  <div class="table-responsive">
                    <table class="table table-sm table-striped align-middle">
                      <thead class="table-light">
                        <tr>
                          <th>Descrição do Bem</th>
                          <th>Tipo de Envolvimento</th>
                          <th>Observação</th>
                          <th class="text-center">Ação</th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (ctrl of bensArray().controls; let i = $index; track i) {
                        <tr [formGroupName]="i">
                          <!-- DESCRIÇÃO (via getBemDescricao) -->
                          <td class="text-truncate" style="max-width: 250px;">
                            {{ getBemDescricao(ctrl.get('bemId')?.value) }}
                          </td>

                          <!-- TIPO DE ENVOLVIMENTO -->
                          <td>
                            <select formControlName="tipoEnvolvimento" class="form-select form-select-sm">
                              @for (t of bemTipoEnvolvimento; track t.key) {
                              <option [value]="t.key">{{ t.value }}</option>
                              }
                            </select>
                          </td>

                          <!-- OBSERVAÇÃO -->
                          <td>
                            <input formControlName="observacao" type="text" class="form-control form-control-sm"
                              placeholder="Opcional">
                          </td>

                          <!-- REMOVER -->
                          <td class="text-center">
                            <button type="button" class="btn btn-outline-danger btn-sm" (click)="removerBem(i)">
                              Remover
                            </button>
                          </td>
                        </tr>
                        }
                      </tbody>
                    </table>
                  </div>
                  } @else {
                  <p class="text-muted fst-italic">Nenhum bem adicionado ao inquérito.</p>
                  }
                </div>
              </div>

            </div>
          </div>

          <!-- Footer -->
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-success" [disabled]="inqueritoForm.invalid">
              {{ isEdicao() ? 'Atualizar' : 'Salvar' }}
            </button>
          </div>

        </form>
      </div>
    </div>
  </div>
</div>