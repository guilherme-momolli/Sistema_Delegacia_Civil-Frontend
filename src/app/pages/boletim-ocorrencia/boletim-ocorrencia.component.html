<div class="container py-4">
  <h1 class="h3 mb-4">Boletins de Ocorrência</h1>

  <div class="mb-3">
    <button class="btn btn-primary" (click)="abrirModal()">
      Cadastrar Boletim
    </button>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th>Nº BO</th>
          <th>Data/Hora</th>
          <th>Natureza</th>
          <th>Local</th>
          <th>Pessoas</th>
          <th>Bens</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        @for (bo of boletins(); track bo.id) {
        <tr>
          <td><strong>{{ bo.boletim }}</strong></td>
          <td>{{ bo.dataOcorrencia | date:'dd/MM/yyyy HH:mm' }}</td>
          <td>{{ bo.natureza }}</td>
          <td>{{ bo.endereco?.logradouro || '—' }}</td>
          <td>{{ bo.pessoasEnvolvidas?.length || 0 }}</td>
          <td>{{ bo.bensEnvolvidos?.length || 0 }}</td>
          <td>
            <button class="btn btn-warning btn-sm me-1" (click)="abrirModal(bo)" title="Editar">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-danger btn-sm" (click)="confirmarExclusao(bo)" title="Excluir">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
        } @empty {
        <tr>
          <td colspan="7" class="text-center text-muted">Nenhum boletim cadastrado.</td>
        </tr>
        }
      </tbody>
    </table>
  </div>

  <div class="modal fade" id="boletimModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <form [formGroup]="boletimForm" (ngSubmit)="salvar()">
          <div class="modal-header">
            <h5 class="modal-title">
              {{ isEdicao() ? 'Editar' : 'Novo' }} Boletim de Ocorrência
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <ul class="nav nav-tabs mb-3" role="tablist">
              <li class="nav-item">
                <button type="button" class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-boletim">Boletim</button>
              </li>
              <li class="nav-item">
                <button type="button" class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-endereco">Endereço</button>
              </li>
              <li class="nav-item">
                <button type="button" class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-pessoas">Pessoas</button>
              </li>
              <li class="nav-item">
                <button type="button" class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-bens">Bens</button>
              </li>
            </ul>

            <div class="tab-content">

              <div class="tab-pane fade show active" id="tab-boletim">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Nº do Boletim *</label>
                    <input formControlName="boletim" class="form-control" placeholder="BO-2025-001" />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Data/Hora *</label>
                    <input formControlName="dataOcorrencia" type="datetime-local" class="form-control" />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Natureza *</label>
                    <input formControlName="natureza" class="form-control" />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Representação</label>
                    <input formControlName="representacao" class="form-control" />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Origem da Força *</label>
                    <select formControlName="origemForcaPolicial" class="form-select">
                      <option value="">Selecione...</option>
                      @for (o of origens; track o.key) {
                      <option [value]="o.key">{{ o.value }}</option>
                      }
                    </select>
                  </div>
                </div>
              </div>

              <div class="tab-pane fade" id="tab-endereco">
                <div formGroupName="endereco" class="row g-3">
                  <div class="col-md-3">
                    <label class="form-label">CEP *</label>
                    <input formControlName="cep" class="form-control" placeholder="00000-000" maxlength="9"
                      (input)="formatarCep($event)" />
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">UF *</label>
                    <select formControlName="uf" class="form-select">
                      <option value="">UF</option>
                      @for (u of ufs; track u.key) {
                      <option [value]="u.key">{{ u.value }}</option>
                      }
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Município *</label>
                    <input formControlName="municipio" class="form-control" />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Bairro *</label>
                    <input formControlName="bairro" class="form-control" />
                  </div>
                  <div class="col-md-8">
                    <label class="form-label">Logradouro *</label>
                    <input formControlName="logradouro" class="form-control" />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Número *</label>
                    <input formControlName="numero" class="form-control" />
                  </div>
                </div>
              </div>

              <div class="tab-pane fade" id="tab-pessoas">
                <div class="row g-2 mb-3">
                  <div class="col-md-4">
                    <input type="text" class="form-control form-control-sm" placeholder="Nome"
                      (input)="atualizarFiltroPessoaNome($event)">
                  </div>
                  <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" placeholder="CPF"
                      (input)="atualizarFiltroPessoaCpf($event)">
                  </div>
                  <div class="col-md-3">
                    <select class="form-select form-select-sm" (change)="atualizarFiltroPessoaSexo($event)">
                      <option value="">Todos os sexos</option>
                      @for (g of generos; track g.key) {
                      <option [value]="g.key">{{ g.value }}</option>
                      }
                    </select>
                  </div>
                  <div class="col-md-2">
                    <button type="button" class="btn btn-primary btn-sm w-100" (click)="buscarPessoas()">Buscar</button>
                  </div>
                </div>

                @if (pessoasFiltradas().length > 0) {
                <div class="table-responsive mb-3" style="max-height: 200px; overflow-y: auto;">
                  <table class="table table-sm table-hover">
                    <thead class="table-light sticky-top">
                      <tr>
                        <th>Nome</th>
                        <th>CPF</th>
                        <th>Tipo</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (p of pessoasFiltradas(); track p.id) {
                      <tr>
                        <td>{{ p.nome }}</td>
                        <td>{{ p.cpf }}</td>
                        <td>
                          <select class="form-select form-select-sm" #tipoPessoa>
                            @for (t of tiposEnvolvimento; track t.key) {
                            <option [value]="t.key">{{ t.value }}</option>
                            }
                          </select>
                        </td>
                        <td>
                          <button type="button" class="btn btn-success btn-sm" (click)="adicionarPessoa(p, tipoPessoa.value)">
                            Adicionar
                          </button>
                        </td>
                      </tr>
                      }
                    </tbody>
                  </table>
                </div>
                } @else {
                <p class="text-muted fst-italic">Nenhuma pessoa encontrada.</p>
                }

                <h6 class="mt-3">Pessoas Envolvidas:</h6>
                <div formArrayName="pessoasEnvolvidas">
                  @if (pessoasArray().length > 0) {
                  <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                    <table class="table table-sm table-striped">
                      <thead class="table-light sticky-top">
                        <tr>
                          <th>Nome</th>
                          <th>Tipo</th>
                          <th>Observação</th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (ctrl of pessoasArray().controls; let i = $index; track i) {
                        <tr [formGroupName]="i">
                          <td>{{ getPessoaNome(ctrl.get('pessoaId')?.value) }}</td>
                          <td>
                            <select formControlName="tipoEnvolvimento" class="form-select form-select-sm">
                              @for (t of tiposEnvolvimento; track t.key) {
                              <option [value]="t.key">{{ t.value }}</option>
                              }
                            </select>
                          </td>
                          <td>
                            <input formControlName="observacao" class="form-control form-control-sm"
                              placeholder="Opcional">
                          </td>
                          <td>
                            <button type="button" class="btn btn-outline-danger btn-sm" (click)="removerPessoa(i)">
                              Remover
                            </button>
                          </td>
                        </tr>
                        }
                      </tbody>
                    </table>
                  </div>
                  } @else {
                  <p class="text-muted fst-italic">Nenhuma pessoa adicionada.</p>
                  }
                </div>
              </div>

              <div class="tab-pane fade" id="tab-bens">
                <div class="row g-2 mb-3">
                  <div class="col-md-4">
                    <input type="text" class="form-control form-control-sm" placeholder="Descrição"
                      (input)="atualizarFiltroBemDescricao($event)">
                  </div>
                  <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" placeholder="Marca"
                      (input)="atualizarFiltroBemMarca($event)">
                  </div>
                  <div class="col-md-3">
                    <select class="form-select form-select-sm" (change)="atualizarFiltroBemTipo($event)">
                      <option value="">Todos os tipos</option>
                      @for (t of tiposBem; track t.key) {
                      <option [value]="t.key">{{ t.value }}</option>
                      }
                    </select>
                  </div>
                  <div class="col-md-2">
                    <button type="button" class="btn btn-primary btn-sm w-100" (click)="buscarBens()">Buscar</button>
                  </div>
                </div>

                @if (bensFiltrados().length > 0) {
                <div class="table-responsive mb-3" style="max-height: 200px; overflow-y: auto;">
                  <table class="table table-sm table-hover">
                    <thead class="table-light sticky-top">
                      <tr>
                        <th>Descrição</th>
                        <th>Marca/Modelo</th>
                        <th>Tipo</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (b of bensFiltrados(); track b.id) {
                      <tr>
                        <td>{{ b.descricao }}</td>
                        <td>{{ b.marca }} {{ b.modelo }}</td>
                        <td>
                          <select class="form-select form-select-sm" #tipoBem>
                            @for (t of bemTipoEnvolvimento; track t.key) {
                            <option [value]="t.key">{{ t.value }}</option>
                            }
                          </select>
                        </td>
                        <td>
                          <button type="button" class="btn btn-success btn-sm" (click)="adicionarBem(b, tipoBem.value)">
                            Adicionar
                          </button>
                        </td>
                      </tr>
                      }
                    </tbody>
                  </table>
                </div>
                } @else {
                <p class="text-muted fst-italic">Nenhum bem encontrado.</p>
                }

                <h6 class="mt-3">Bens Envolvidos:</h6>
                <div formArrayName="bensEnvolvidos">
                  @if (bensArray().length > 0) {
                  <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                    <table class="table table-sm table-striped">
                      <thead class="table-light sticky-top">
                        <tr>
                          <th>Descrição</th>
                          <th>Tipo</th>
                          <th>Observação</th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (ctrl of bensArray().controls; let i = $index; track i) {
                        <tr [formGroupName]="i">
                          <td>{{ getBemDescricao(ctrl.get('bemId')?.value) }}</td>
                          <td>
                            <select formControlName="tipoEnvolvimento" class="form-select form-select-sm">
                              @for (t of bemTipoEnvolvimento; track t.key) {
                              <option [value]="t.key">{{ t.value }}</option>
                              }
                            </select>
                          </td>
                          <td>
                            <input formControlName="observacao" class="form-control form-control-sm"
                              placeholder="Opcional">
                          </td>
                          <td>
                            <button type="button" class="btn btn-outline-danger btn-sm" (click)="removerBem(i)">
                              Remover
                            </button>
                          </td>
                        </tr>
                        }
                      </tbody>
                    </table>
                  </div>
                  } @else {
                  <p class="text-muted fst-italic">Nenhum bem adicionado.</p>
                  }
                </div>
              </div>

            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-success" [disabled]="boletimForm.invalid">
              {{ isEdicao() ? 'Atualizar' : 'Salvar' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>